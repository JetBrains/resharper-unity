import org.apache.tools.ant.taskdefs.condition.Os

plugins {
    id 'java'
    id 'org.jetbrains.kotlin.jvm' version '1.2.41'
    id 'org.jetbrains.intellij' version '0.3.2'
}

ext.repoRoot = new File("..").canonicalFile
ext.isWindows = Os.isFamily(Os.FAMILY_WINDOWS)


wrapper {
    distributionType = Wrapper.DistributionType.ALL
}

if (System.env['TEAMCITY_VERSION'] != null) {
    ext.ci = new TeamCityService()
    ext.isBuildingUnderCi = true
    gradle.taskGraph.addTaskExecutionListener(new TeamCityEventLogger(ci))
} else if (System.env['TRAVIS'] != null) {
    ext.ci = new TravisService()
    ext.isBuildingUnderCi = true
    gradle.taskGraph.addTaskExecutionListener(new TravisEventLogger(ci))
} else {
    ext.ci = new NullService()
    ext.isBuildingUnderCi = false
}

// Renaming to be more meaningful, but would also require updating build.ps1
// and also the build configuration settings in TeamCity
if (!ext.has("Source"))
    ext.Source = new File(ext.repoRoot, "rider/build/riderRD-2018.2-SNAPSHOT/lib/ReSharperHostSdk")    
ext.PackageSource = ext.Source

if (!ext.has("BuildCounter"))
    ext.BuildCounter = 9999

if (!ext.has("BuildConfiguration")) {
    ext.BuildConfiguration = ext.isBuildingUnderCi ? "Release" : "Debug"
}

if (!ext.has('dotNetUpToDate') || ext.dotNetUpToDate ==~ "(?i)False")
    ext.dotNetUpToDate = false

ext.shouldBuildRiderOnly = false

version "2018.2.0.$BuildCounter"

logger.lifecycle("version=$version")
logger.lifecycle("Configuration=$BuildConfiguration")

apply from: 'backend.gradle'
apply from: 'frontend.gradle'

task resolveDependencies {
  description 'Resolves all projects dependencies from the repository'
  group 'Build Server'

  doLast {
    rootProject.allprojects { project ->
      project.buildscript.configurations.forEach { configuration ->
        if (configuration.canBeResolved) {
          configuration.resolve()
        }
      }

      project.configurations.forEach { configuration ->
        if (configuration.canBeResolved) {
          configuration.resolve()
        }
      }
    }
  }
}

interface CIService {
    void Progress(String message)
    void OpenBlock(String name, String description)
    void CloseBlock(String name)
    void PublishArtifact(File path)
}

class NullService implements CIService {

    void Progress(String message) {
        println message
    }

    void OpenBlock(String name, String description) { }
    void CloseBlock(String name) { }

    void PublishArtifact(File path) {
        println "Publish: $path.absolutePath"
    }

    void SetBuildNumber(String version) {
        println "Build: $version"
    }
}

class TeamCityService implements CIService {

    // TODO: These values should be escaped
    void Progress(String message) {
        println "##teamcity[progressMessage '$message']"
    }

    void OpenBlock(String name, String description) {
        println "##teamcity[blockOpened name='$name' description='$description']"
    }

    void CloseBlock(String name) {
        println "##teamcity[blockClosed name='$name']"
    }

    void PublishArtifact(File path) {
        println "##teamcity[publishArtifacts '$path.absolutePath']"
    }

    void SetBuildNumber(String version) {
        println "##teamcity[buildNumber '$version']"
    }
}

class TeamCityEventLogger extends BuildAdapter implements TaskExecutionListener {

    private CIService ci

    TeamCityEventLogger(CIService ci) {
        this.ci = ci
    }

    void beforeExecute(Task task) {
        ci.Progress("gradle:$task.name")
        ci.OpenBlock("gradle:$task.name", "gradle:$task.name")
    }

    void afterExecute(Task task, TaskState state) {
        ci.CloseBlock("gradle:$task.name")
    }
}


class TravisService implements CIService {

    void Progress(String message) {
        println message
    }

    void OpenBlock(String name, String description) {
        println "travis_fold:start:$name\033[33;1m:$description\033[0m"
    }

    void CloseBlock(String name) {
        println "\ntravis_fold:end:$name\r"
    }

    void PublishArtifact(File path) {
        println "Artifact: $path.absolutePath"
    }

    void SetBuildNumber(String version) {
        println "Build number: $version"
    }
}

class TravisEventLogger extends BuildAdapter implements TaskExecutionListener {

    private CIService ci

    TravisEventLogger(CIService ci) {
        this.ci = ci
    }

    void beforeExecute(Task task) {
        ci.OpenBlock(task.name, task.name)
    }

    void afterExecute(Task task, TaskState state) {
        ci.CloseBlock(task.name)
    }
}

